---
- name: Setup Kafka
  hosts: test-servers
  vars:
    user: jeffravi
    group: jeffravi
    homedir: 
    repo: https://github.com/jeffreypeter/airavata.git
    work_dir: /home/{{ user }}/airavata
    kafka_dir: /home/{{ user }}/airavata/dev-tools/docker/kafka
    elk_dir: /home/{{ user }}/airavata/dev-tools/docker/elk
  become: true
  become_user: jeffravi
  become_method: sudo
  gather_facts: true
  tasks:
    - name: Install Packages
      yum: name={{ item }} state=latest update_cache=yes
      with_items: 
        - git
        - python-setuptools
        - docker-ce

    - name: Create Work directory
      file: path="{{ work_dir }}" state=directory owner="{{user}}" group="{{group}}"
      become: yes

    - name: Git clone airavta
      git:
       repo: "{{ repo }}"
       dest: "{{ work_dir }}"
       version: "kafka"
       update: yes
       force: yes
    
    - name: Run local zookeeper
      become: yes
      register: test
      docker_container:
        name: zookeeper
        image: jplock/zookeeper
        pull: true
        ports:
             - "2181:2181"

    - name: Build Kafka
      become: yes
      docker_image:
        name: airavata/kafka
        path: "{{ kafka_dir }}"

    - name: Run Kafka
      become: yes
      docker_container:
        name: kafka
        image: airavata/kafka
        links:
          - zookeeper:zookeeper

    - name: Build ELK Stack
      become: yes
      docker_image: 
        name: airavata/elk
        path: "{{ elk_dir }}"

    - name: Set Config for ELK Stack
      become: yes
      command: sysctl -w vm.max_map_count=262144

    - name: Run ELK Stack
      become: yes
      docker_container:
        name: elk
        image: airavata/elk
        ports:
          - "5601:5601"
          - "9200:9200"
          - "5044:5044"

    - name: Create topic
      become: yes
      command: docker run --rm airavata/kafka kafka-topics.sh --create --topic test_all_logs --replication-factor 1 --partitions 1 --zookeeper 172.17.0.2:2181

    - name: Start Custom Logstash
      become: yes
      command: docker exec -d elk /bin/bash -c '/opt/logstash/bin/logstash -f /opt/logstash/airavata/logstash-airavata.conf --path.data /opt/logstash/airavata'


