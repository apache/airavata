#
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

---
# Generate keystore from Let's Encrypt certificates
# This must run AFTER Let's Encrypt role has generated certificates

- name: Set Let's Encrypt certificate directory
  set_fact:
    letsencrypt_cert_dir: "/etc/letsencrypt/live/{{ api_server_public_hostname | default('localhost') }}"

- name: Check if Let's Encrypt certificate exists
  stat:
    path: "{{ letsencrypt_cert_dir }}/fullchain.pem"
  register: letsencrypt_cert_check
  become: yes
  become_user: root

- name: Fail if Let's Encrypt certificate not found
  fail:
    msg: "Let's Encrypt certificate not found at {{ letsencrypt_cert_dir }}/fullchain.pem. Run Let's Encrypt role first."
  when: not letsencrypt_cert_check.stat.exists

- name: Create temporary directory for keystore generation
  file:
    path: "/tmp/keystore-generation"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0700"
  become: yes


- name: Create keystores directory
  file:
    path: "{{ api_server_dir }}/conf/keystores"
    state: directory
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0700"
  become: yes

- name: Copy Let's Encrypt certificates to temp directory (for user access)
  copy:
    src: "{{ item }}"
    dest: "/tmp/keystore-generation/{{ item | basename }}"
    remote_src: yes
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0600"
  loop:
    - "{{ letsencrypt_cert_dir }}/fullchain.pem"
    - "{{ letsencrypt_cert_dir }}/privkey.pem"
  become: yes
  become_user: root
  when: letsencrypt_cert_check.stat.exists

- name: Detect Java home if not already set
  shell: find /usr/lib/jvm -name java -type f -path "*/bin/java" 2>/dev/null | head -1 | xargs dirname | xargs dirname
  register: detected_java_home
  changed_when: false
  failed_when: false
  when: java_home is not defined

- name: Set Java home from detected path
  set_fact:
    java_home: "{{ detected_java_home.stdout }}"
  when: java_home is not defined and detected_java_home.stdout != ""

- name: Set default Java home if detection failed
  set_fact:
    java_home: "{{ '/usr/lib/jvm/java-17-openjdk-amd64' if ansible_os_family == 'Debian' else '/usr/lib/jvm/java-17' }}"
  when: java_home is not defined

- name: Generate AES-256 key for credential encryption
  shell: |
    keytool -genseckey -alias airavata -keyalg AES -keysize 256 \
      -keystore /tmp/keystore-generation/aes.p12 \
      -storepass "{{ keystore_password }}"
  args:
    chdir: "/tmp/keystore-generation"
    creates: "/tmp/keystore-generation/aes.p12"
  become: yes
  become_user: "{{ deploy_user }}"
  environment:
    JAVA_HOME: "{{ java_home }}"
    PATH: "{{ java_home }}/bin:{{ ansible_env.PATH }}"
  when: letsencrypt_cert_check.stat.exists

- name: Generate keystore from Let's Encrypt certificates
  shell: |
    openssl pkcs12 -export -name tls \
      -out /tmp/keystore-generation/airavata.p12 \
      -passout pass:{{ keystore_password }} \
      -in /tmp/keystore-generation/fullchain.pem \
      -inkey /tmp/keystore-generation/privkey.pem && \
    keytool -importkeystore \
      -srckeystore /tmp/keystore-generation/aes.p12 \
      -destkeystore /tmp/keystore-generation/airavata.p12 \
      -srcstorepass {{ keystore_password }} \
      -deststorepass {{ keystore_password }} \
      -noprompt && \
    cp /tmp/keystore-generation/airavata.p12 {{ api_server_dir }}/conf/keystores/{{ vault_keystore_file }}
  args:
    chdir: "/tmp/keystore-generation"
  become: yes
  become_user: "{{ deploy_user }}"
  environment:
    JAVA_HOME: "{{ java_home }}"
    PATH: "{{ java_home }}/bin:{{ ansible_env.PATH }}"
  when: letsencrypt_cert_check.stat.exists

- name: Set proper permissions on keystore
  file:
    path: "{{ api_server_dir }}/conf/keystores/{{ vault_keystore_file }}"
    owner: "{{ deploy_user }}"
    group: "{{ deploy_user }}"
    mode: "0600"
  become: yes
  when: letsencrypt_cert_check.stat.exists

- name: Clean up temporary directory
  file:
    path: "/tmp/keystore-generation"
    state: absent
  become: yes
  when: always | default(true)

