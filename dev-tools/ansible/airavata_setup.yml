#
#
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
#

---
# Airavata Full Environment Setup Playbook
# 
# This playbook sets up a complete Airavata environment from scratch including:
#   - Environment setup (users, groups, firewall)
#   - Java and Maven installation
#   - Zookeeper installation and configuration
#   - Kafka installation and configuration
#   - RabbitMQ installation and configuration
#   - MariaDB installation and configuration
#   - SSL certificate setup (Let's Encrypt)
#   - Airavata services build and deployment
#
# Usage:
#   ansible-playbook -i inventories/<env> airavata_setup.yml --ask-vault-pass
#
# Prerequisites:
#   - Clean server with root/sudo access
#   - DNS configured (for Let's Encrypt)

- name: Full Airavata Environment Setup
  hosts: airavata_servers
  become: yes
  
  roles:
    # Environment and prerequisites
    - role: env_setup
      tags:
        - env_setup
    
    # Java installation
    - role: java
      tags:
        - java
    
    # Maven, Git, and source checkout
    - role: common
      become: yes
      become_user: "{{ user | default('airavata') }}"
      tags:
        - common
    
    # Zookeeper installation and configuration
    - role: zookeeper
      tags:
        - zookeeper
        - airavata
    
    # Kafka installation and configuration
    - role: kafka
      tags:
        - kafka
        - airavata
    
    # RabbitMQ installation and configuration
    - role: rabbitmq
      tags:
        - rabbitmq
        - airavata
    
    # MariaDB installation and configuration
    - role: database
      tags:
        - database
    
    # SSL certificates (Let's Encrypt)
    - role: letsencrypt
      tags:
        - ssl
        - letsencrypt
    
    # Build and deploy Airavata services
    - role: airavata_services
      become: yes
      become_user: "{{ user | default('airavata') }}"
      tags:
        - airavata_services
        - deploy

